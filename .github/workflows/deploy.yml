name: VDS Deploy

on:
    push:
        branches:
            - master

jobs:
    deploy:
        runs-on: ubuntu-22.04

        steps:
            - name: Deploy using SSH
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: ${{ secrets.DEPLOY_SERVER_HOST }}
                  username: ${{ secrets.DEPLOY_SERVER_USER }}
                  key: ${{ secrets.SSH_PRIVATE_KEY }}
                  script: |
                      echo "ğŸš€ Starting deployment..."
                      cd /home/hfk/backend/final-proje/server
                      echo "âœ… Navigated to project directory"

                      # EÄŸer hala VDS'de manuel deÄŸiÅŸiklik yapma ihtimalin varsa,
                      # bu satÄ±rlarÄ± aktif bÄ±rakmak iyi olabilir.
                      echo "ğŸ”„ Discarding local changes (if any)..."
                      git reset --hard HEAD
                      git clean -fd
                      echo "âœ… Local changes discarded"

                      echo " pulling latest changes..."
                      git pull origin master
                      echo "âœ… Code updated"


                      export NVM_DIR="$HOME/.nvm"
                      if [ -s "$NVM_DIR/nvm.sh" ]; then
                        echo "âœ… NVM installation found."
                      else
                        echo "âŒ NVM installation not found at $NVM_DIR"
                        exit 1
                      fi

                      echo "ğŸ“¦ Installing/updating dependencies using nvm exec..."
                      nvm exec default npm ci 
                      echo "âœ… Dependencies installed"

                      echo "ğŸ”„ Reloading PM2 application using nvm exec..."
                      nvm exec default pm2 reload my-api 
                      echo "âœ… PM2 application reloaded"

                      echo "ğŸ‰ Deployment finished!"
